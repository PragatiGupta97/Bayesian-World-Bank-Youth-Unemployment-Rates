---
title: "BDA Project"
author: "Dylan, Francesco, Pragati"
output:
  pdf_document:
    toc: yes
    toc_depth: 1
  html_document:
    toc: yes
    toc_depth: '1'
    df_print: paged
  word_document:
    toc: yes
    toc_depth: '1'
---



```{r setup, include=FALSE}
# This chunk sets echo = TRUE as default, that is print all code.
# knitr::opts_chunk$set can be used to set other notebook generation options, too.
# include=FALSE inside curly brackets makes this block not be included in the pdf
knitr::opts_chunk$set(echo = TRUE)
```


```{r, results='hide',message=FALSE,include=FALSE}
#Loaded packages
# To install aaltobda, see the General information in the assignment.
library(aaltobda)
library(rstan)
library(bayesplot)
options(mc.cores = parallel::detectCores(),control = list(max_treedepth = 11))
rstan_options(auto_write = TRUE)
set.seed(123)

```

```{r}
QSAR <- read.csv(file = 'qsar_aquatic_toxicity.csv')
colnames(QSAR)
```


```{r}

for(col in colnames(QSAR))
{
  #if(col!="quantitative_response")
    QSAR[col]<-scale(QSAR[col])  
  
}
```

#creating linear model

```{r}
#fullmodel=lm(X2014~poly(X2013,3)+poly(X2012,3)+poly(X2011,3)+poly(X2010,3),data=YE)

fullmodel=lm(quantitative_response~TSPA+Saacc+H050+MLOGP+RDCHI+GATS1p+nN+C040, data =QSAR)
summary(fullmodel)
```

# 1) Introduction

## Motivation
## The problem
## Modeling idea

## illustrative figure is recommended.

```{r}

plot(QSAR$quantitative_response,fullmodel$res, ylab="e_bar", xlab="y_bar", main="Residual plot")
abline(0,0)


```

```{r}
par(mfrow=c(3,3))
cols = colnames(QSAR)

for(col in cols)
{ 
plot(density(QSAR[col][,1]))
  
}

```

# 2) Description of the data and the analysis problem. 

Provide information where the data was obtained, and if it has been previously used in some online case study and how your analysis differs from the existing analyses.

# 3) Description of at least two models, for example:

## non hierarchical and hierarchical,

## linear and non linear
## variable selection with many models.

# 4) Informative or weakly informative priors
and justification of their choices.

# 5) Stan code 
(brms can be used to generate the code, but Stan code needs to be present and explained).


```{r}
TSPA=QSAR$TSPA[,1]
Saacc=QSAR$Saacc[,1]
H050=QSAR$H050[,1]
MLOGP=QSAR$MLOGP[,1]
RDCHI=QSAR$RDCHI[,1]
GATS1p=QSAR$GATS1p[,1]
nN=QSAR$nN[,1]
C040=QSAR$C040[,1]
qr=QSAR$quantitative_response[,1]
n=dim(QSAR)[1]

qsar_data <-list(N=n,qr=qr,TSPA=TSPA,Saacc=Saacc,H050=H050,MLOGP=MLOGP,RDCHI=RDCHI,GATS1p=GATS1p,nN=nN,C040=C040)

model_simple <-stan(file = 'QSARproject.stan' , data = qsar_data, chains=4, iter=1000)
print(model_simple)
```

```{r}
params=extract(model_simple, permuted=FALSE, inc_warmup=TRUE)
#fit_summary <- summary(model_simple)
#View(fit_summary$summary)
#print(params)
#monitor(params)
```


# 6) How to the Stan model was run

that is, what options were used. This is also more clear as combination of textual explanation and the actual code line.

```{r}

#mcmc_trace(as.array(model_simple), pars = c("a","b","c","d","e","f","g","h","i"), facet_args = list(nrow = 3))
traceplot(model_simple, pars=c("a","b","c","d","e","f","g","h","i"))
```


```{r}

```

# 7) Convergence diagnostics 

(RË†, ESS, divergences) and what was done if the convergence was not good with the first try.

1 traceplot-done
2 rhat - done


3 neff- done

```{r}
neff=summary(model_simple)$summary[,'n_eff']
val=neff/1000 
#print(val)
which(val < 0.01)
```

samples/ total iterations > 0.01, this means samples are not biased and true effect of sample size is not overestimated.



4) BUlk ESS and tail ess over 100 for all the parameters

5) divergences

```{r}

pairs(model_simple,pars=c("a","b","c","d","e","f","g","h","i"))
```

```{r}
get_num_divergent(model_simple)
```

No divergences in the pairplot


# 8) Posterior predictive checks

and what was done to improve the model.
```{r}
# instead of log, use rng
par( mfrow = c(1,2) )
plot(density(QSAR$quantitative_response[,1]),main="Posterior predictive check for simle model")
params<-extract(model_simple)
for (ind in 1980:2000)
{
  lines(density(params$gen_lik[ind,]), col='red');
}

```

# 9) Model comparison 
(e.g. with LOO-CV).

```{r}
library(loo)
loo_model_simple <- loo(extract_log_lik(model_simple))
loo_model_simple
```

```{r}
plot(loo_model_simple, main = "PSIS Diagonostic for simple Model")
```

# 10) Predictive performance assessment 

if applicable (e.g. classification accuracy) and evaluation of practical usefulness of the accuracy.

# 11) Sensitivity analysis 

with respect to prior choices (i.e. checking whether the result changes a lot if prior is changed)

# 12) Discussion of issues and potential improvements.

# 13) Conclusion 

what was learned from the data analysis.

# 14) Self-reflection of what the group learned while making the project.


